<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Widget Décompte — IRC Anonyme</title>
  <style>
    :root{
      --bg:#1a1a1a;--text:#fff;--chat-bg:#000;--nick:#00ff00;--highlight:#555;--chroma:#00ff00;--count:#fff;--border:#333;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:Inter, Arial, sans-serif;height:100vh;display:flex;flex-direction:column}
    header{padding:14px 18px;border-bottom:1px solid var(--border);font-size:20px;font-weight:700;text-align:center}
    .wrap{display:flex;gap:16px;padding:16px;flex:1}
    .left{flex:1;display:flex;flex-direction:column;gap:8px}
    .card{background:var(--chat-bg);border-radius:6px;padding:10px;border:1px solid var(--border)}
    label{font-size:13px;color:#ccc;margin-bottom:6px;display:block}
    input[type="text"]{width:100%;padding:8px;border-radius:5px;border:1px solid var(--border);background:#0b0b0b;color:var(--text)}
    #chat{flex:1;overflow:auto;font-family:monospace;font-size:14px;padding:8px;background:#000;border-radius:6px;border:1px solid var(--border)}
    .line{margin:6px 0}
    .nick{color:var(--nick);font-weight:700;margin-right:6px}
    mark.k{background:var(--highlight);color:inherit;padding:0 3px;border-radius:3px}
    .right{width:340px;display:flex;flex-direction:column;gap:12px}
    .chroma{background:var(--chroma);color:var(--count);font-weight:900;font-size:64px;text-align:center;border-radius:8px;padding:18px 0}
    .btn{padding:8px;border-radius:6px;border:1px solid var(--border);background:#222;color:var(--text);cursor:pointer}
    footer{padding:12px 18px;border-top:1px solid var(--border);font-size:13px;color:#999}
  </style>
</head>
<body>
  <header>Widget Décompte</header>
  <div class="wrap">
    <div class="left">
      <div class="card">
        <label>Nom de la chaîne (ex: okplonk)</label>
        <input id="channel" type="text" placeholder="okplonk">
      </div>
      <div id="chat" class="card" aria-live="polite"></div>
      <div id="status" style="font-size:13px;color:#bbb;padding-top:4px">Statut : prêt.</div>
    </div>

    <div class="right">
      <div class="card">
        <label>Mot à décompter (compte toutes les occurrences)</label>
        <input id="keyword" type="text" placeholder="ex : echo">
      </div>
      <div class="card">
        <label>Compteur (cadre chroma)</label>
        <div id="counter" class="chroma">0</div>
      </div>
      <div class="card">
        <label>Couleur fond (HEX)</label>
        <input id="bgHex" type="text" value="#00ff00">
      </div>
      <div class="card">
        <label>Couleur chiffre (HEX)</label>
        <input id="numHex" type="text" value="#ffffff">
      </div>
      <div style="display:flex;gap:8px">
        <button id="connect" class="btn">Connecter</button>
        <button id="reset" class="btn">Réinitialiser</button>
      </div>
    </div>
  </div>
  <footer>Connexion anonyme au chat Twitch via IRC (méthode justinfanXXXX). Aucun token requis.</footer>

  <script>
    const $ = id => document.getElementById(id);
    const chat = $('chat'), status = $('status'), counterEl = $('counter');
    let ws=null, nick='justinfan'+Math.floor(Math.random()*1e6);
    let count = parseInt(localStorage.getItem('count')||'0',10)||0;
    let channel = localStorage.getItem('channel')||'';
    let keyword = localStorage.getItem('keyword')||'';
    let bgHex = localStorage.getItem('bgHex')||'#00ff00';
    let numHex = localStorage.getItem('numHex')||'#ffffff';
    $('counter').textContent = count;
    $('channel').value = channel;
    $('keyword').value = keyword;
    $('bgHex').value = bgHex;
    $('numHex').value = numHex;
    applyColors();

    function saveAll(){
      localStorage.setItem('count', count);
      localStorage.setItem('channel', $('channel').value.trim());
      localStorage.setItem('keyword', $('keyword').value);
      localStorage.setItem('bgHex', $('bgHex').value);
      localStorage.setItem('numHex', $('numHex').value);
    }

    function applyColors(){
      document.documentElement.style.setProperty('--chroma',$('bgHex').value);
      document.documentElement.style.setProperty('--count',$('numHex').value);
      counterEl.style.background = $('bgHex').value;
      counterEl.style.color = $('numHex').value;
    }

    function setStatus(t){ status.textContent='Statut : '+t; console.log('[WIDGET]',t); }

    function escapeHtml(s){ return s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
    function escapeRegExp(s){ return s.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'); }

    function appendMessage(user,msg){
      let safe = escapeHtml(msg);
      const kw = $('keyword').value.trim();
      if(kw){
        try{ const re=new RegExp('('+escapeRegExp(kw)+')','ig'); safe=safe.replace(re,'<mark class=\"k\">$1</mark>'); }catch{}
      }
      const div=document.createElement('div'); div.className='line';
      div.innerHTML='<span class=\"nick\">'+escapeHtml(user)+'</span>: '+safe;
      chat.appendChild(div);
      while(chat.children.length>500) chat.removeChild(chat.firstChild);
      chat.scrollTop=chat.scrollHeight;

      if(kw){
        try{
          const re=new RegExp(escapeRegExp(kw),'ig');
          const matches=msg.match(re);
          if(matches){ count+=matches.length; counterEl.textContent=count; saveAll(); }
        }catch{}
      }
    }

    function connectIRC(){
      const chan=$('channel').value.trim().toLowerCase();
      if(!chan){ setStatus('Indique un nom de chaîne'); return; }
      saveAll();
      if(ws){ try{ ws.close(); }catch{} }
      setStatus('Connexion au chat de '+chan+'...');
      ws=new WebSocket('wss://irc-ws.chat.twitch.tv:443');
      ws.onopen=()=>{
        setStatus('Connecté au serveur IRC, authentification...');
        send('CAP REQ :twitch.tv/tags twitch.tv/commands');
        send('PASS SCHMOOPIIE');
        send('NICK '+nick);
        send('JOIN #'+chan);
      };
      ws.onerror=e=>{ setStatus('Erreur WebSocket.'); console.error(e); };
      ws.onclose=()=>{ setStatus('Déconnecté — reconnexion dans 3s...'); setTimeout(connectIRC,3000); };
      ws.onmessage=ev=>{ handleMessage(ev.data); };
    }

    function send(line){ try{ ws && ws.send(line); }catch(e){ console.warn('Send error',e); } }

    function handleMessage(raw){
      const lines = raw.split(/\\r?\\n/).filter(Boolean);
      for(const line of lines){
        if(line.startsWith('PING')){ send('PONG :tmi.twitch.tv'); continue; }
        const match = line.match(/^(?:@[^ ]* )?:([^!]+)!.* PRIVMSG #[^ ]+ :(.*)$/);
        if(match){ const user=(match[1]||'').toLowerCase(); const msg=match[2]||''; appendMessage(user,msg); }
      }
    }

    $('connect').addEventListener('click', connectIRC);
    $('reset').addEventListener('click', ()=>{ count=0; counterEl.textContent='0'; saveAll(); });
    $('keyword').addEventListener('input', saveAll);
    $('bgHex').addEventListener('input', ()=>{ applyColors(); saveAll(); });
    $('numHex').addEventListener('input', ()=>{ applyColors(); saveAll(); });
    $('channel').addEventListener('keydown', e=>{ if(e.key==='Enter') connectIRC(); });

    if($('channel').value){ setTimeout(connectIRC,500); }
  </script>
</body>
</html>
