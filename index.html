<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Widget Décompte — Twitch Chat</title>
  <style>
    :root{
      --bg:#1a1a1a;--text:#fff;--chat-bg:#000;--nick:#00ff00;--highlight:#555;--chroma:#00ff00;--count:#fff;--muted:#bdbdbd;--border:#333;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:Inter, Arial, sans-serif;height:100vh;display:flex;flex-direction:column}
    header{padding:14px 18px;border-bottom:1px solid var(--border);font-size:20px;font-weight:700;text-align:center}
    .wrap{display:flex;gap:16px;padding:16px;flex:1}
    .left{flex:1;display:flex;flex-direction:column;gap:8px}
    .card{background:var(--chat-bg);border-radius:6px;padding:10px;border:1px solid var(--border)}
    label{font-size:13px;color:var(--muted);margin-bottom:6px;display:block}
    input[type="text"], input[type="password"]{width:100%;padding:8px;border-radius:5px;border:1px solid var(--border);background:#0b0b0b;color:var(--text)}
    #chat{flex:1;overflow:auto;font-family:monospace;font-size:14px;padding:8px;background:#000;border-radius:6px;border:1px solid var(--border)}
    .line{margin:6px 0}
    .nick{color:var(--nick);font-weight:700;margin-right:6px}
    mark.k{background:var(--highlight);color:inherit;padding:0 3px;border-radius:3px}
    .right{width:340px;display:flex;flex-direction:column;gap:12px}
    .chroma{background:var(--chroma);color:var(--count);font-weight:900;font-size:64px;text-align:center;border-radius:8px;padding:18px 0}
    .muted{color:var(--muted);font-size:13px}
    .btn{padding:8px;border-radius:6px;border:1px solid var(--border);background:#222;color:var(--text);cursor:pointer}
    footer{padding:12px 18px;border-top:1px solid var(--border);font-size:13px;color:var(--muted)}
    a.link{color:#94e2ff}
  </style>
</head>
<body>
  <header>Widget Décompte</header>
  <div class="wrap">
    <div class="left">
      <div class="card">
        <label>Nom de la chaîne / Pseudo Twitch (ex: okplonk)</label>
        <input id="user" type="text" placeholder="okplonk">
      </div>

      <div class="card">
        <label>Token Twitch (user OAuth)</label>
        <input id="token" type="password" placeholder="oauth:xxxxxxxxxxxxxxxxxxxx">
        <div class="muted" style="margin-top:8px">
          Besoin d’un token ? Utilise <a class="link" href="https://twitchtokengenerator.com" target="_blank" rel="noopener">twitchtokengenerator.com</a> et coche le scope <code>chat:read</code> (lecture du chat).
        </div>
      </div>

      <div id="chat" class="card" aria-live="polite"></div>
      <div id="status" class="muted" style="padding-top:6px">Statut : prêt.</div>
    </div>

    <div class="right">
      <div class="card">
        <label>Mot à décompter (compte toutes les occurrences)</label>
        <input id="keyword" type="text" placeholder="echo">
      </div>

      <div class="card">
        <label>Compteur (cadre chroma)</label>
        <div id="counter" class="chroma">0</div>
      </div>

      <div class="card">
        <label>Couleur fond (HEX)</label>
        <input id="bgHex" type="text" value="#00ff00">
      </div>

      <div class="card">
        <label>Couleur chiffre (HEX)</label>
        <input id="numHex" type="text" value="#ffffff">
      </div>

      <div style="display:flex;gap:8px">
        <button id="connect" class="btn">Connecter</button>
        <button id="reset" class="btn">Réinitialiser</button>
      </div>
    </div>
  </div>

  <footer>Token et paramètres sauvegardés localement. Le pseudo doit correspondre au compte lié au token OAuth.</footer>

  <script>
    const $ = id => document.getElementById(id);
    const chat = $('chat'), status = $('status'), counterEl = $('counter');
    let ws = null;

    let count = parseInt(localStorage.getItem('count')||'0',10)||0;
    let user = localStorage.getItem('user')||'';
    let token = localStorage.getItem('token')||'';
    let keyword = localStorage.getItem('keyword')||'';
    let bgHex = localStorage.getItem('bgHex')||'#00ff00';
    let numHex = localStorage.getItem('numHex')||'#ffffff';

    $('counter').textContent = count;
    $('user').value = user;
    $('token').value = token;
    $('keyword').value = keyword;
    $('bgHex').value = bgHex;
    $('numHex').value = numHex;
    applyColors();

    function saveAll(){
      localStorage.setItem('count', count);
      localStorage.setItem('user', $('user').value.trim());
      localStorage.setItem('token', $('token').value.trim());
      localStorage.setItem('keyword', $('keyword').value);
      localStorage.setItem('bgHex', $('bgHex').value);
      localStorage.setItem('numHex', $('numHex').value);
    }

    function applyColors(){
      document.documentElement.style.setProperty('--chroma',$('bgHex').value);
      document.documentElement.style.setProperty('--count',$('numHex').value);
      counterEl.style.background = $('bgHex').value;
      counterEl.style.color = $('numHex').value;
    }

    function setStatus(t){ status.textContent='Statut : '+t; console.log('[WIDGET]',t); }

    function escapeHtml(s){ return s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
    function escapeRegExp(s){ return s.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'); }

    function appendMessage(user,msg){
      let safe = escapeHtml(msg);
      const kw = $('keyword').value.trim();
      if(kw){
        try{ const re=new RegExp('('+escapeRegExp(kw)+')','ig'); safe=safe.replace(re,'<mark class=\"k\">$1</mark>'); }catch{}
      }
      const div=document.createElement('div'); div.className='line';
      div.innerHTML='<span class=\"nick\">'+escapeHtml(user)+'</span>: '+safe;
      chat.appendChild(div);
      while(chat.children.length>500) chat.removeChild(chat.firstChild);
      chat.scrollTop=chat.scrollHeight;

      if(kw){
        try{
          const re=new RegExp(escapeRegExp(kw),'ig');
          const matches=msg.match(re);
          if(matches){ count+=matches.length; counterEl.textContent=count; saveAll(); }
        }catch{}
      }
    }

    function connectIRC(){
      const username=$('user').value.trim().toLowerCase();
      const tok=$('token').value.trim();
      if(!username){ setStatus('Indique ton pseudo Twitch'); return; }
      if(!tok.startsWith('oauth:')){ setStatus('Token invalide (doit commencer par oauth:)'); return; }
      saveAll();
      if(ws){ try{ ws.close(); }catch{} }
      ws=new WebSocket('wss://irc-ws.chat.twitch.tv:443');
      ws.onopen=()=>{
        setStatus('Ouvert — authentification...');
        ws.send('CAP REQ :twitch.tv/tags twitch.tv/commands twitch.tv/membership');
        ws.send('PASS '+tok);
        ws.send('NICK '+username);
        ws.send('JOIN #'+username);
        setStatus('Connecté à #'+username+' en tant que '+username);
      };
      ws.onmessage=ev=>{
        const lines=ev.data.split(/\\r?\\n/).filter(Boolean);
        for(const line of lines){
          if(line.startsWith('PING')){ try{ ws.send('PONG :tmi.twitch.tv'); }catch{}; continue; }
          if(line.includes('PRIVMSG')){
            // parse user + message robustement
            const userMatch=line.match(/display-name=([^;]+)/);
            const displayName=userMatch ? userMatch[1] : (line.match(/:([^!]+)!/)||['','?'])[1];
            const msgMatch=line.match(/PRIVMSG\\s+#[^\\s]+\\s+:(.*)/);
            if(msgMatch){ onMsg(displayName,msgMatch[1]); }
          }
        }
      };
      ws.onclose=()=>{ setStatus('Déconnecté — reconnexion dans 3s...'); setTimeout(connectIRC,3000); };
      ws.onerror=()=>setStatus('Erreur WebSocket.');
    }

    function onMsg(user,msg){ appendMessage(user,msg); }

    $('connect').addEventListener('click', connectIRC);
    $('reset').addEventListener('click', ()=>{ count=0; counterEl.textContent='0'; saveAll(); });
    $('keyword').addEventListener('input', saveAll);
    $('bgHex').addEventListener('input', ()=>{ applyColors(); saveAll(); });
    $('numHex').addEventListener('input', ()=>{ applyColors(); saveAll(); });
    $('user').addEventListener('keydown', e=>{ if(e.key==='Enter') connectIRC(); });
    $('token').addEventListener('keydown', e=>{ if(e.key==='Enter') connectIRC(); });

    if($('user').value && $('token').value){ setTimeout(connectIRC,500); }
  </script>
</body>
</html>
